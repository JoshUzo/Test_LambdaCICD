name: Deploy Lambda Function

on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Code Review with AWS CodeGuru
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set Up AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Run CodeGuru Reviewer
        run: |
          aws codeguru-reviewer create-code-review \
            --name LambdaCodeReview \
            --type=RepositoryAnalysis \
            --repository-association-arn arn:aws:codeguru-reviewer:us-east-2:211125625532:association/8ea0af07-f446-4b8c-a194-5d82039208bd \
            
      - name: Wait for CodeGuru Analysis
        run: |
          echo "Waiting for CodeGuru review..."
          sleep 300  # Wait for analysis to complete (adjust as needed)
      
      - name: Fetch CodeGuru Results
        run: |
          aws codeguru-reviewer list-code-reviews --type RepositoryAnalysis --status Completed
          
  deploy:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v2
      - name: Install zip tool
        uses: montudor/action-zip@v1
      - name: Create Zip file for Lambda function
        run: |
          cd src
          zip -r ../code.zip .
      - name: AWS CLI v2
        uses: imehedi/actions-awscli-v2@latest
        with:
          args: "lambda update-function-code \
            --function-name arn:aws:lambda:us-east-2:211125625532:function:TestFunction \
            --zip-file fileb://code.zip"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "us-east-2"
